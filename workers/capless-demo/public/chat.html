<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parliament Chat - Ask Questions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-message {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-4xl mx-auto px-4 py-4 sm:px-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Parliament Chat</h1>
                    <p class="text-sm text-gray-500 mt-1">Ask questions about parliamentary sessions</p>
                </div>
                <a href="/" class="text-sm text-indigo-600 hover:text-indigo-700 font-medium">
                    ‚Üê Back to Moments
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-6 sm:px-6">
        <!-- Session Selector -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Select Session</label>
            <div class="flex gap-3">
                <input type="text" id="sessionDate" value="22-09-2024"
                       class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border"
                       placeholder="DD-MM-YYYY">
                <button onclick="checkSessionStatus()"
                        class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors text-sm font-medium">
                    Check Status
                </button>
            </div>
            <div id="sessionStatus" class="mt-2 text-sm"></div>
        </div>

        <!-- Chat Container -->
        <div class="bg-white rounded-lg shadow-lg flex flex-col" style="height: calc(100vh - 300px);">
            <!-- Messages Area -->
            <div id="messages" class="flex-1 overflow-y-auto p-6 space-y-4">
                <!-- Welcome message -->
                <div class="chat-message">
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-4 border border-indigo-100">
                        <h3 class="font-semibold text-gray-900 mb-2">Welcome to Parliament Chat! üëã</h3>
                        <p class="text-sm text-gray-700 mb-2">Ask questions about the parliamentary session on 22 September 2024.</p>
                        <div class="text-xs text-gray-600">
                            <p class="mb-1">Example questions:</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>"What did the Deputy Prime Minister say about COE allocation?"</li>
                                <li>"What was discussed about public sector integrity?"</li>
                                <li>"Who spoke about transport policy?"</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-200 p-4">
                <form onsubmit="sendMessage(event)" class="flex gap-3">
                    <input type="text" id="questionInput"
                           class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3 border"
                           placeholder="Ask a question about the parliamentary session..."
                           required>
                    <button type="submit" id="sendButton"
                            class="px-6 py-3 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors text-sm font-medium disabled:bg-gray-300 disabled:cursor-not-allowed">
                        Send
                    </button>
                </form>
                <div class="mt-2 flex items-center gap-2 text-xs text-gray-500">
                    <span id="statusIndicator">‚óè</span>
                    <span id="statusText">Ready</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        const CHAT_API = 'https://parliament-chat.erniesg.workers.dev';
        const messagesContainer = document.getElementById('messages');
        const questionInput = document.getElementById('questionInput');
        const sendButton = document.getElementById('sendButton');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');

        // Check session status
        async function checkSessionStatus() {
            const sessionDate = document.getElementById('sessionDate').value;
            const statusDiv = document.getElementById('sessionStatus');

            statusDiv.innerHTML = '<span class="text-gray-500">Checking...</span>';

            try {
                const response = await fetch(`${CHAT_API}/session/${sessionDate}/status`);
                const data = await response.json();

                if (data.is_embedded) {
                    statusDiv.innerHTML = `
                        <span class="text-green-600">‚úì Session embedded (${data.chunk_count} chunks)</span>
                        <span class="text-gray-500 ml-2">Ready for questions!</span>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <span class="text-yellow-600">‚ö† Session not embedded yet</span>
                        <button onclick="embedSession('${sessionDate}')"
                                class="ml-2 text-indigo-600 hover:text-indigo-700 text-sm underline">
                            Embed now
                        </button>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `<span class="text-red-600">Error: ${error.message}</span>`;
            }
        }

        // Embed session
        async function embedSession(sessionDate) {
            const statusDiv = document.getElementById('sessionStatus');
            statusDiv.innerHTML = '<span class="text-blue-600">Embedding session... (this may take a few seconds)</span>';

            try {
                const response = await fetch(`${CHAT_API}/embed-session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_date: sessionDate, force: true })
                });

                const data = await response.json();

                if (response.ok) {
                    statusDiv.innerHTML = `
                        <span class="text-green-600">‚úì Session embedded successfully!</span>
                        <span class="text-gray-500 ml-2">${data.chunk_count} chunks created</span>
                    `;
                } else {
                    throw new Error(data.message || 'Embedding failed');
                }
            } catch (error) {
                statusDiv.innerHTML = `<span class="text-red-600">Error: ${error.message}</span>`;
            }
        }

        // Add message to chat
        function addMessage(text, isUser = false, metadata = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';

            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="flex justify-end">
                        <div class="bg-indigo-600 text-white rounded-lg px-4 py-3 max-w-2xl">
                            <p class="text-sm">${escapeHtml(text)}</p>
                        </div>
                    </div>
                `;
            } else {
                let citationsHtml = '';
                if (metadata && metadata.citations) {
                    citationsHtml = `
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <p class="text-xs font-semibold text-gray-700 mb-2">üìö Sources:</p>
                            ${metadata.citations.map((citation, i) => `
                                <div class="text-xs text-gray-600 mb-2">
                                    <span class="font-medium">[${i + 1}] ${citation.speaker || 'Unknown'}:</span>
                                    <span class="italic">"${citation.text.substring(0, 100)}..."</span>
                                    <span class="text-gray-500">(${(citation.confidence * 100).toFixed(0)}% match)</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                messageDiv.innerHTML = `
                    <div class="flex justify-start">
                        <div class="bg-gray-100 rounded-lg px-4 py-3 max-w-2xl">
                            <p class="text-sm text-gray-900 whitespace-pre-wrap">${escapeHtml(text)}</p>
                            ${citationsHtml}
                            ${metadata ? `<p class="text-xs text-gray-500 mt-2">Model: ${metadata.model}</p>` : ''}
                        </div>
                    </div>
                `;
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Send message
        async function sendMessage(event) {
            event.preventDefault();

            const question = questionInput.value.trim();
            if (!question) return;

            const sessionDate = document.getElementById('sessionDate').value;

            // Add user message
            addMessage(question, true);
            questionInput.value = '';

            // Update UI
            sendButton.disabled = true;
            statusIndicator.style.color = '#3B82F6'; // blue
            statusText.textContent = 'Thinking...';

            try {
                const response = await fetch(`${CHAT_API}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_date: sessionDate,
                        question: question,
                        max_results: 3
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addMessage(data.answer, false, {
                        citations: data.citations,
                        model: data.model
                    });
                    statusIndicator.style.color = '#10B981'; // green
                    statusText.textContent = 'Ready';
                } else {
                    addMessage(`Error: ${data.message}`, false);
                    statusIndicator.style.color = '#EF4444'; // red
                    statusText.textContent = 'Error occurred';
                }
            } catch (error) {
                addMessage(`Network error: ${error.message}`, false);
                statusIndicator.style.color = '#EF4444'; // red
                statusText.textContent = 'Connection failed';
            } finally {
                sendButton.disabled = false;
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkSessionStatus();
            statusIndicator.style.color = '#10B981'; // green
        });
    </script>
</body>
</html>
