<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capless - Viral Parliamentary Moments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Capless</h1>
                    <p class="text-sm text-gray-500 mt-1">Parliament Session: 22 September 2025</p>
                </div>
                <div class="flex items-center gap-6">
                    <a href="/chat.html"
                       class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors text-sm font-medium">
                        ðŸ’¬ Ask Questions
                    </a>
                    <div class="text-right">
                        <p class="text-sm font-medium text-gray-600">Viral Moments</p>
                        <p class="text-3xl font-bold text-indigo-600" id="momentCount">3</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Panel: YouTube Video -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="bg-gray-900 aspect-video relative">
                    <div id="player"></div>
                </div>
                <div class="p-4 border-t border-gray-200">
                    <h3 class="font-semibold text-gray-900 mb-2">Parliament Sitting 22 September 2025</h3>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500" id="currentTimestamp">00:00:00</span>
                        <a href="https://www.youtube.com/watch?v=n9ZyN-lwiXg" target="_blank"
                           class="text-sm text-indigo-600 hover:text-indigo-700 font-medium">
                            Watch on YouTube â†’
                        </a>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Viral Moments List -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col max-h-[600px]">
                <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-purple-50">
                    <h2 class="text-lg font-bold text-gray-900">Viral Moments</h2>
                    <p class="text-sm text-gray-600 mt-1">Click any moment to jump to the timestamp</p>
                </div>

                <div class="overflow-y-auto flex-1" id="momentsList">
                    <!-- Moments will be loaded here by JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <!-- App JavaScript -->
    <script>
        // Hardcoded data
        const VIDEO_ID = 'n9ZyN-lwiXg';
        const MOMENTS = [
            {
                "moment_id": "demo-moment-1",
                "quote": "The alterations were done to cover up the incompleteness of documents but the contents were factual.",
                "speaker": "Minister (PUB)",
                "timestamp_start": "01:29:46",
                "virality_score": 10,
                "why_viral": "Minimizes document falsification - sounds like cover-up language",
                "topic": "Public Sector Integrity"
            },
            {
                "moment_id": "demo-moment-2",
                "quote": "It is challenging for the government to allocate COEs based on needs. No matter how one draws the line, there will always be people who believe they are more deserving.",
                "speaker": "Transport Minister",
                "timestamp_start": "09:20:34",
                "virality_score": 10,
                "why_viral": "Admits difficulty but uses it as reason for inaction - excuse-making rather than problem-solving",
                "topic": "COE policy and fairness"
            },
            {
                "moment_id": "demo-moment-3",
                "quote": "The market mechanism is transparent and allows government to channel COE revenues to benefit the wider public.",
                "speaker": "Transport Minister",
                "timestamp_start": "09:24:37",
                "virality_score": 10,
                "why_viral": "Defends market-based system as fair while acknowledging it prices out families - contradictory logic",
                "topic": "COE policy and market mechanism"
            }
        ];

        let player;
        let currentMomentIndex = null;

        // Convert timestamp HH:MM:SS to seconds
        function timestampToSeconds(timestamp) {
            const parts = timestamp.split(':').map(Number);
            return parts[0] * 3600 + parts[1] * 60 + parts[2];
        }

        // Convert seconds to HH:MM:SS
        function secondsToTimestamp(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        // YouTube Player Ready
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: VIDEO_ID,
                playerVars: {
                    'playsinline': 1,
                    'rel': 0,
                    'modestbranding': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            console.log('YouTube player ready');
            // Update current time display
            setInterval(() => {
                if (player && player.getCurrentTime) {
                    const currentTime = player.getCurrentTime();
                    document.getElementById('currentTimestamp').textContent = secondsToTimestamp(currentTime);
                }
            }, 1000);
        }

        function onPlayerStateChange(event) {
            // Handle player state changes if needed
        }

        // Jump to timestamp in video
        function jumpToTimestamp(timestamp, momentIndex) {
            const seconds = timestampToSeconds(timestamp);
            if (player && player.seekTo) {
                player.seekTo(seconds, true);
                player.playVideo();

                // Update active moment
                currentMomentIndex = momentIndex;
                renderMoments();
            }
        }

        // API Configuration
        const VIDEO_API_URL = 'https://capless-video-generator.erniesg.workers.dev';

        // Generate reaction video
        async function generateReactionVideo(moment) {
            // Show persona selection modal
            const persona = await showPersonaModal();
            if (!persona) return; // User cancelled

            // Start video generation
            showLoadingToast(`Generating ${persona.replace('_', ' ')} reaction...`);

            try {
                const response = await fetch(`${VIDEO_API_URL}/api/video/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        moment_id: moment.moment_id,
                        persona: persona
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to start video generation');
                }

                // Poll for video status
                pollVideoStatus(data.job_id, data.poll_url);
            } catch (error) {
                showErrorToast(error.message);
            }
        }

        // Show persona selection modal
        function showPersonaModal() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                        <div class="p-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">Select Reaction Persona</h3>
                            <div class="space-y-3">
                                <button onclick="selectPersona('gen_z')" class="w-full text-left p-4 border-2 border-gray-200 rounded-lg hover:border-indigo-600 hover:bg-indigo-50 transition-colors">
                                    <div class="font-semibold text-gray-900">Gen Z</div>
                                    <div class="text-sm text-gray-600">Truth-telling jester calling out hypocrisy</div>
                                </button>
                                <button onclick="selectPersona('kopitiam_uncle')" class="w-full text-left p-4 border-2 border-gray-200 rounded-lg hover:border-indigo-600 hover:bg-indigo-50 transition-colors">
                                    <div class="font-semibold text-gray-900">Kopitiam Uncle</div>
                                    <div class="text-sm text-gray-600">Practical wisdom from seasoned observer</div>
                                </button>
                                <button onclick="selectPersona('auntie')" class="w-full text-left p-4 border-2 border-gray-200 rounded-lg hover:border-indigo-600 hover:bg-indigo-50 transition-colors">
                                    <div class="font-semibold text-gray-900">Auntie</div>
                                    <div class="text-sm text-gray-600">Concerned protector with kiasu energy</div>
                                </button>
                                <button onclick="selectPersona('attenborough')" class="w-full text-left p-4 border-2 border-gray-200 rounded-lg hover:border-indigo-600 hover:bg-indigo-50 transition-colors">
                                    <div class="font-semibold text-gray-900">Attenborough</div>
                                    <div class="text-sm text-gray-600">Nature documentary narrator style</div>
                                </button>
                            </div>
                            <button onclick="selectPersona(null)" class="mt-4 w-full px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;

                window.selectPersona = (persona) => {
                    document.body.removeChild(modal);
                    resolve(persona);
                };

                document.body.appendChild(modal);
            });
        }

        // Poll for video status
        async function pollVideoStatus(jobId, pollUrl) {
            const maxAttempts = 60; // 5 minutes (5 second intervals)
            let attempts = 0;

            const poll = async () => {
                try {
                    const response = await fetch(`${VIDEO_API_URL}${pollUrl}`);
                    const data = await response.json();

                    if (data.status === 'completed') {
                        showVideoModal(data);
                    } else if (data.status === 'failed') {
                        showErrorToast('Video generation failed: ' + (data.error || 'Unknown error'));
                    } else {
                        attempts++;
                        if (attempts < maxAttempts) {
                            // Update progress
                            const progress = data.progress || 'Processing...';
                            showLoadingToast(`${progress} (${attempts * 5}s elapsed)`);
                            setTimeout(poll, 5000);
                        } else {
                            showErrorToast('Video generation timeout - please try again');
                        }
                    }
                } catch (error) {
                    showErrorToast('Failed to check video status: ' + error.message);
                }
            };

            poll();
        }

        // Show video modal
        function showVideoModal(data) {
            hideToast();

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-900">Video Generated!</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="width" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>

                        <div class="aspect-video bg-black rounded-lg overflow-hidden mb-4">
                            <video controls autoplay class="w-full h-full">
                                <source src="${data.video_url}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <p class="text-sm font-semibold text-gray-700 mb-2">Generated Script:</p>
                            <p class="text-sm text-gray-600">${data.scripts?.[0]?.script || 'N/A'}</p>
                        </div>

                        <div class="flex gap-2">
                            <a href="${data.video_url}" download class="flex-1 px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition-colors text-center">
                                Download Video
                            </a>
                            ${data.youtube_link ? `
                                <a href="${data.youtube_link}${data.youtube_timestamp ? '?t=' + data.youtube_timestamp : ''}" target="_blank" class="flex-1 px-4 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 rounded-md hover:bg-indigo-100 transition-colors text-center">
                                    View on YouTube
                                </a>
                            ` : ''}
                            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Toast notifications
        let currentToast = null;

        function showLoadingToast(message) {
            hideToast();
            currentToast = document.createElement('div');
            currentToast.className = 'fixed bottom-4 right-4 bg-indigo-600 text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 z-50';
            currentToast.innerHTML = `
                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>${message}</span>
            `;
            document.body.appendChild(currentToast);
        }

        function showErrorToast(message) {
            hideToast();
            currentToast = document.createElement('div');
            currentToast.className = 'fixed bottom-4 right-4 bg-red-600 text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 z-50';
            currentToast.innerHTML = `
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <span>${message}</span>
            `;
            document.body.appendChild(currentToast);
            setTimeout(hideToast, 5000);
        }

        function hideToast() {
            if (currentToast) {
                document.body.removeChild(currentToast);
                currentToast = null;
            }
        }

        // Render moments list
        function renderMoments() {
            const momentsList = document.getElementById('momentsList');
            momentsList.innerHTML = MOMENTS.map((moment, index) => {
                const isActive = currentMomentIndex === index;
                return `
                    <div class="p-4 border-b border-gray-200 hover:bg-gray-50 transition-colors cursor-pointer ${isActive ? 'bg-indigo-50 border-l-4 border-l-indigo-600' : ''}"
                         onclick="jumpToTimestamp('${moment.timestamp_start}', ${index})">

                        <!-- Header: Speaker & Timestamp -->
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                                    ${moment.speaker}
                                </span>
                                <span class="text-xs text-gray-500">${moment.timestamp_start}</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                                </svg>
                                <span class="text-sm font-bold text-red-500">${moment.virality_score}</span>
                            </div>
                        </div>

                        <!-- Quote -->
                        <blockquote class="text-sm text-gray-900 leading-relaxed mb-3 italic border-l-3 border-gray-300 pl-3">
                            "${moment.quote}"
                        </blockquote>

                        <!-- Why Viral -->
                        <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3 mb-3">
                            <p class="text-xs font-semibold text-yellow-800 mb-1">ðŸ”¥ Why This Will Go Viral:</p>
                            <p class="text-xs text-yellow-900">${moment.why_viral}</p>
                        </div>

                        <!-- Topic Badge -->
                        <div class="flex items-center justify-between">
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-700">
                                ðŸ“‹ ${moment.topic}
                            </span>
                            <button
                                onclick="event.stopPropagation(); generateReactionVideo(${JSON.stringify(moment).replace(/"/g, '&quot;')})"
                                class="px-3 py-1 text-xs font-medium text-white bg-indigo-600 rounded hover:bg-indigo-700 transition-colors">
                                Generate Clip
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            renderMoments();
        });
    </script>
</body>
</html>
